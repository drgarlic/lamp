#!/usr/bin/env bash
#
#   \|/   '||     ^   ||\/| ||''.
#  - o -   ||    //\  ||  | ||--'
#   /|\   .||_| //''\ ||  | ||
#
# Description:              Deamon-less terminal effect manager
# Dependencies:             art, wmctrl, xdpyinfo
# Optionnal dependencies:   none
# Author:                   gawlk
# Contributors:             none

# ---
# IMPORTS
# ---

. art-api

# ---
# SETUP
# ---

# Disable unicode.
LC_ALL=C
LANG=C

mode=2

# ---
# LOCAL
# ---

lamp.unfocus_color() {
    local colors=( $( pure.hex_to_rgb "$1" ) )
    local R="${colors[0]}"
    local G="${colors[1]}"
    local B="${colors[2]}"

    local value=$2
    [[ "$3" == "dark" ]] && value=$(( - value ))
   
    (( R += value ))
    (( G += value ))
    (( B += value ))
    
    [[ $R -lt 0 ]] && R=0
    [[ $G -lt 0 ]] && G=0
    [[ $B -lt 0 ]] && B=0
    [[ $R -gt 255 ]] && R=255
    [[ $G -gt 255 ]] && G=255
    [[ $B -gt 255 ]] && B=255

    pure.rgb_to_hex "$R" "$G" "$B"
}

lamp.update_terminals() {
    for term in "/dev/pts/"[0-9]*
    do  
        [[ -w "$term" ]] && [[ "$term" != "$1" ]] && ( printf "%b" "$2" > "$term" & )
    done
}

# ---
# MAIN
# ---

lamp.main() {
    # Get id of the focused window
    local focused_id=$( xdpyinfo | grep -Eo 'window 0x[^,]+' | cut -d" " -f2 | cut -c 3- )

    # Check if the focused window is a terminal
    local focused_dev_pts=$( wmctrl -l | grep "${focused_id}.*/dev/pts/" | awk '{ print $4 }' )

    # If it is a terminal
    if [[ -n "$focused_dev_pts" ]]
    then
        case "$mode" in
            "1")
                local colors=( $( art-api.get_colors ) )
                
                local sequences=$( setters.sequences ${colors[@]} )

                printf "%b" "$sequences" > $focused_dev_pts &

                local brightness=$( art-api.get_brightness )

                # Generate unfosed colors
                local value=32
                local blk="${colors[0]}"
                local gry=$( lamp.unfocus_color "${colors[1]}" $value "$brightness" )
                local red=$( lamp.unfocus_color "${colors[2]}" $value "$brightness" )
                local grn=$( lamp.unfocus_color "${colors[3]}" $value "$brightness" )
                local blu=$( lamp.unfocus_color "${colors[4]}" $value "$brightness" )
                (( value *= 2 ))
                local wht=$( lamp.unfocus_color "${colors[5]}" $value "$brightness" )
                
                # Update unfocused terminals
                sequences=$( setters.sequences "$blk" "$gry" "$red" "$grn" "$blu" "$wht" )

                lamp.update_terminals "$focused_dev_pts" "$sequences"
            ;;
            "2")
                local theme=$( art-api.get_theme )
                local brightness=$( art-api.get_brightness )
                [[ "$brightness" == "dark" ]] && brightness="light" || brightness="dark"

                local colors=( $( art-api.get_colors ) )

                local sequences=$( setters.sequences ${colors[@]} )

                printf "%b" "$sequences" > "$focused_dev_pts" &

                [[ "$brightness" == "dark" ]] && brightness="light" || brightness="dark"
                colors=( $( art-api.get_colors ) )

                sequences=$( setters.sequences ${colors[@]} )

                lamp.update_terminals "$focused_dev_pts" "$sequences"
            ;;
        esac
    fi
}

# ---
# LAUNCH
# ---

lamp.main
